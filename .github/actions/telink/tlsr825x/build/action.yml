name: 'Build a Telink tlsr825x project'
description: 'Install the Telink IDE, Zigbee SDK and the build a tlsr825x project'
inputs:
  ide:
    description: Location of the Telink IDE
    default: c:\telink\ide
  zigbee_sdk:
    description: Location of the Telink Zigbee SDK
    default: c:\telink\zigbee_sdk
  project:
    description: tlsr825x project to build
    default: sampleGW_8258
  board:
    description: tlsr825x board to target
    default:

env:
  WORKSPACES: "tl_zigbee_sdk\build"
  PROJECT_ROOT: "tlsr_tc32"

runs:
  using: "composite"
  steps:
    - name: Build TLSR8258 ZigBee image
      shell: pwsh
      run: |
        $eclipsec=Get-ChildItem -Path "${{ inputs.ide }}\eclipsec.exe" -Recurse
        $eclipsec
        # Run eclipsec, waiting for it to complte, redirecting output etc.
        $proc=Start-Process `
          -FilePath $eclipsec[0].FullName `
          -ArgumentList `
            "-vm `
            ""${{ inputs.ide }}\jre\bin\client"" `
            -noSplash `
            -application org.eclipse.cdt.managedbuilder.core.headlessbuild `
            -data ""${{ inputs.zigbee_sdk }}\$env:WORKSPACES"" `
            -build ""$env:PROJECT_ROOT/${{ inputs.project }}""" `
          -NoNewWindow `
          -RedirectStandardOutput $env:TEMP\stdout.txt `
          -RedirectStandardError $env:TEMP\stderr.txt `
          -Wait `
          -PassThru
        Write-Information "eclipsec exit code: $($proc.ExitCode.ToString())" -InformationAction:Continue
        # Display output, especially any errors!
        Write-Information "STDOUT from the installer..." -InformationAction:Continue
        Get-Content -Path $env:TEMP\stdout.txt
        Write-Information "STDERR from the installer..." -InformationAction:Continue
        Get-Content -Path $env:TEMP\stderr.txt
        # Capture first line of errors to test later.
        $stderr = $(Get-Content  -Path $env:TEMP\stderr.txt -First 1)
        Remove-Item -Path $env:TEMP\stdout.txt
        Remove-Item -Path $env:TEMP\stderr.txt

        # Builds worked it all of the following are true:
        # - ExitCode is zero (0)
        # - stderr log output is empty
        # - an 'elf' image has been created
        if ($proc.ExitCode -ne 0)
        {
          Write-Error "eclipsec exited with $proc.ExitCode." -ErrorAction:Continue
          exit 1
        }
        elseif ($stderr -ne "")
        {
          Write-Error "eclipsec reported errors." -ErrorAction:Continue
          exit 1
        }
        elseif ((! $(Test-Path -Path ${{ inputs.zigbee_sdk }}\$env:WORKSPACES\$env:PROJECT_ROOT\${{ inputs.project }}\${{ inputs.project }}.elf) -or
                (! $(Test-Path -Path ${{ inputs.zigbee_sdk }}\$env:WORKSPACES\$env:PROJECT_ROOT\${{ inputs.project }}\${{ inputs.project }}.bin) -or
                (! $(Test-Path -Path ${{ inputs.zigbee_sdk }}\$env:WORKSPACES\$env:PROJECT_ROOT\${{ inputs.project }}\${{ inputs.project }}.lst))
        {
          Write-Error "eclipsec did not generate all expected files." -ErrorAction:Continue
          Get-ChildItem -Path "${{ inputs.zigbee_sdk }}\$env:WORKSPACES\$env:PROJECT_ROOT\${{ inputs.project }}\${{ inputs.project }}.*"
          exit 1
        }
        else
        {
          Write-Information "eclipsec build succeeded." -InformationAction:Continue
        }

  - name: 'Upload tlsr825x image'
    uses: actions/upload-artifact@v3
    with:
      name: tlsr825x-firmware
      path: "${{ inputs.zigbee_sdk }}\$env:WORKSPACES\$env:PROJECT_ROOT\${{ inputs.project }}\${{ inputs.project }}.*"
      retention-days: 1
